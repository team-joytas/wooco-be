name: Deploy PROD

on:
  workflow_dispatch:
  release:
    types: [ published ]

jobs:
  docker-build-and-push:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: 리포지토리 체크아웃
        uses: actions/checkout@v3

      - name: JDK 21 버전 설치
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: PROD 배포 환경변수 설정
        run: |
          echo "${{ secrets.SPRING_ENV }}" | base64 -d > bootstrap/api/src/main/resources/.env

      - name: Gradle 캐싱
        uses: actions/cache@v4
        id: cache-gradle
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Gradle 을 통해 빌드
        run: |
          chmod +x ./gradlew
          ./gradlew :bootstrap:api:bootJar

      - name: Docker 빌드 도구 설정
        uses: docker/setup-buildx-action@v2.9.1

      - name: Docker Hub 로그인
        uses: docker/login-action@v2.2.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile-api
          push: true
          platforms: linux/amd64
          tags: ${{ secrets.DOCKER_HUB_REPOSITORY }}:${{ github.event.release.tag_name }}

  # argocd image updater 도입시 제거될 예정
  update-deployment:
    runs-on: ubuntu-latest
    needs: docker-build-and-push
    if: success()

    steps:
      - name: 리포지토리 체크아웃
        uses: actions/checkout@v3
        with:
          repository: ${{ vars.ORG_GITOPS_REPOSITORY }} # team-joytas/wooco-gitops
          token: ${{ secrets.ORG_GITOPS_PAT }}

      - name: 이미지 버전 변경 # kustomize cli 대신 yq 사용
        uses: mikefarah/yq@v4.44.3
        with:
          cmd: >
            yq -i
            '.spec.template.spec.containers[0].image =
            "${{ secrets.DOCKER_HUB_REPOSITORY }}:${{ github.event.release.tag_name }}"'
            ./${{ vars.ORG_GITOPS_PROD_DEPLOYMENT_PATH }}

      # https://github.com/simonw/simonw/issues/11
      - name: 커밋 & 푸시
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "release: Deploy ${{ github.event.release.tag_name }} wooco spring app"
          git remote set-url origin https://${{ secrets.ORG_GITOPS_PAT }}@github.com/${{ vars.ORG_GITOPS_REPOSITORY }}
          git push --set-upstream origin HEAD
